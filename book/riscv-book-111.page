<div id="pf6f" class="pf w0 h0" data-page-no="6f"><div class="pc pc6f w0 h0"><img class="bi x17 y12bb w2 hab" alt="" src="bg6f.png"/><div class="t m0 x17 h7 y147 ff3 fs4 fc0 sc0 ls0 ws0">CHAPTER<span class="_ _2"> </span>8.<span class="_ _19"> </span>IMPLEMENTING<span class="_ _2"> </span>ROUTINES</div><div class="t m0 x17 h7 y1e ff3 fs4 fc0 sc0 ls0 ws0">from<span class="_ _2"> </span>the<span class="_ _2"> </span><span class="ff5">get<span class="_ _b"> </span>current<span class="_ _b"> </span>day<span class="_ _2"> </span></span>routine,<span class="_ _2"> </span>the<span class="_ _2"> </span>stac<span class="_ _1"></span>k<span class="_ _2"> </span>p<span class="_ _4"></span>oin<span class="_ _8"></span>ter<span class="_ _2"> </span>is<span class="_ _2"> </span>increased<span class="_ _2"> </span>to<span class="_ _2"> </span>deallo<span class="_ _4"></span>cate<span class="_ _2"> </span>the<span class="_ _2"> </span><span class="ff5">d</span></div><div class="t m0 x17 h7 yd4 ff3 fs4 fc0 sc0 ls0 ws0">v<span class="_ _8"></span>ariable<span class="_ _2"> </span>(line<span class="_ _2"> </span>6)<span class="_ _2"> </span>from<span class="_ _2"> </span>the<span class="_ _2"> </span>program<span class="_ _2"> </span>stac<span class="_ _1"></span>k.</div><div class="t m0 xd5 h8 y12bc ff24 fs12 fc0 sc0 ls0 ws0">1<span class="_ _16"> </span><span class="ff5 fs4">get_current_day:</span></div><div class="t m0 xd5 h8 y12bd ff24 fs12 fc0 sc0 ls0 ws0">2<span class="_ _32"> </span><span class="ff5 fs4">addi<span class="_ _9"> </span>sp,<span class="_ _31"> </span>sp,<span class="_ _31"> </span>-12<span class="_ _3b"> </span>#<span class="_ _31"> </span>Allocate<span class="_ _31"> </span>d</span></div><div class="t m0 xd5 h8 y12be ff24 fs12 fc0 sc0 ls0 ws0">3<span class="_ _32"> </span><span class="ff5 fs4">mv<span class="_ _3b"> </span>a0,<span class="_ _31"> </span>sp<span class="_ _85"> </span>#<span class="_ _9"> </span>a0<span class="_ _31"> </span>=<span class="_ _31"> </span>address<span class="_ _31"> </span>of<span class="_ _31"> </span>d</span></div><div class="t m0 xd5 h8 y12bf ff24 fs12 fc0 sc0 ls0 ws0">4<span class="_ _32"> </span><span class="ff5 fs4">jal<span class="_ _82"> </span>init_date<span class="_ _86"> </span>#<span class="_ _9"> </span>Invoke<span class="_ _31"> </span>the<span class="_ _31"> </span>init_date<span class="_ _31"> </span>routine</span></div><div class="t m0 xd5 h8 y12c0 ff24 fs12 fc0 sc0 ls0 ws0">5<span class="_ _32"> </span><span class="ff5 fs4">lw<span class="_ _3b"> </span>a0,<span class="_ _31"> </span>8(sp)<span class="_ _86"> </span>#<span class="_ _9"> </span>Load<span class="_ _31"> </span>d.day<span class="_ _31"> </span>into<span class="_ _31"> </span>a0</span></div><div class="t m0 xd5 h8 y12c1 ff24 fs12 fc0 sc0 ls0 ws0">6<span class="_ _32"> </span><span class="ff5 fs4">addi<span class="_ _9"> </span>sp,<span class="_ _31"> </span>sp,<span class="_ _31"> </span>12<span class="_ _81"> </span>#<span class="_ _31"> </span>Deallocate<span class="_ _31"> </span>d</span></div><div class="t m0 xd5 h8 y12c2 ff24 fs12 fc0 sc0 ls0 ws0">7<span class="_ _32"> </span><span class="ff5 fs4">ret</span></div><div class="t m0 x17 hd y12c3 ff7 fs3 fc0 sc0 ls0 ws0">8.7<span class="_ _32"> </span>Register<span class="_ _31"> </span>usage<span class="_ _31"> </span>p<span class="_ _4"></span>olicies</div><div class="t m0 x17 h7 y12c4 ff3 fs4 fc0 sc0 ls0 ws0">The<span class="_ _25"> </span>assembly<span class="_ _a"> </span>co<span class="_ _4"></span>de<span class="_ _25"> </span>examples<span class="_ _25"> </span>in<span class="_ _9"> </span>the<span class="_ _25"> </span>previous<span class="_ _25"> </span>sections<span class="_ _9"> </span>hav<span class="_ _8"></span>e<span class="_ _25"> </span>used<span class="_ _9"> </span>registers<span class="_ _25"> </span>to<span class="_ _25"> </span>hold</div><div class="t m0 x17 h7 y12c5 ff3 fs4 fc0 sc0 ls0 ws0">v<span class="_ _8"></span>ariables<span class="_ _30"> </span>and<span class="_ _2f"> </span>temporary<span class="_ _2f"> </span>v<span class="_ _8"></span>alues,<span class="_ _2f"> </span>to<span class="_ _30"> </span>return<span class="_ _2f"> </span>v<span class="_ _7"></span>alues<span class="_ _2f"> </span>from<span class="_ _30"> </span>routines, and<span class="_ _30"> </span>to<span class="_ _30"> </span>pass<span class="_ _2f"> </span>parameters</div><div class="t m0 x17 h7 y12c6 ff3 fs4 fc0 sc0 ls0 ws0">to<span class="_ _b"> </span>routines.<span class="_ _31"> </span>In<span class="_ _b"> </span>fact,<span class="_ _b"> </span>registers<span class="_ _b"> </span>are<span class="_ _b"> </span>frequen<span class="_ _8"></span>tly<span class="_ _b"> </span>used<span class="_ _b"> </span>resources.<span class="_ _31"> </span>Before<span class="_ _b"> </span>using<span class="_ _b"> </span>a<span class="_ _b"> </span>register,</div><div class="t m0 x17 h7 y12c7 ff3 fs4 fc0 sc0 ls0 ws0">ho<span class="_ _1"></span>w<span class="_ _1"></span>ev<span class="_ _1"></span>er, it ma<span class="_ _1"></span>y be necessary to sa<span class="_ _1"></span>v<span class="_ _1"></span>e its con<span class="_ _8"></span>tents to memory<span class="_ _2f"> </span>so that it can<span class="_ _2f"> </span>be restored</div><div class="t m0 x17 h7 y12c8 ff3 fs4 fc0 sc0 ls0 ws0">later.</div><div class="t m0 x13 h7 y12c9 ff3 fs4 fc0 sc0 ls0 ws0">Let<span class="_ _b"> </span>us<span class="_ _b"> </span>use<span class="_ _b"> </span>as<span class="_ _b"> </span>an<span class="_ _b"> </span>example<span class="_ _b"> </span>the<span class="_ _b"> </span><span class="ff5">exchange<span class="_ _b"> </span></span>routine,<span class="_ _3"> </span>in<span class="_ _8"></span>tro<span class="_ _4"></span>duced<span class="_ _b"> </span>in<span class="_ _b"> </span>Section<span class="_ _b"> </span>8.6.<span class="_ _12"> </span>The</div><div class="t m0 x17 h7 y12ca ff3 fs4 fc0 sc0 ls0 ws0">follo<span class="_ _1"></span>wing<span class="_ _2"> </span>co<span class="_ _4"></span>des<span class="_ _5"> </span>show<span class="_ _5"> </span>its<span class="_ _2"> </span>implementation<span class="_ _5"> </span>in<span class="_ _2"> </span>assembly<span class="_ _5"> </span>language.</div><div class="t m0 xd5 h8 y12cb ff24 fs12 fc0 sc0 ls0 ws0">1<span class="_ _16"> </span><span class="ff5 fs4">exchange:</span></div><div class="t m0 xd5 h8 y12cc ff24 fs12 fc0 sc0 ls0 ws0">2<span class="_ _32"> </span><span class="ff5 fs4">lw<span class="_ _9"> </span>a2,<span class="_ _31"> </span>(a1)<span class="_ _3b"> </span>#<span class="_ _31"> </span>tmp<span class="_ _31"> </span>=<span class="_ _31"> </span>*b</span></div><div class="t m0 xd5 h8 y12cd ff24 fs12 fc0 sc0 ls0 ws0">3<span class="_ _32"> </span><span class="ff5 fs4">lw<span class="_ _9"> </span>a3,<span class="_ _31"> </span>(a0)<span class="_ _3b"> </span>#<span class="_ _31"> </span>a3<span class="_ _31"> </span>=<span class="_ _31"> </span>*a</span></div><div class="t m0 xd5 h8 y12ce ff24 fs12 fc0 sc0 ls0 ws0">4<span class="_ _32"> </span><span class="ff5 fs4">sw<span class="_ _9"> </span>a3,<span class="_ _31"> </span>(a1)<span class="_ _3b"> </span>#<span class="_ _31"> </span>*b<span class="_ _31"> </span>=<span class="_ _31"> </span>a3</span></div><div class="t m0 xd5 h8 y12cf ff24 fs12 fc0 sc0 ls0 ws0">5<span class="_ _32"> </span><span class="ff5 fs4">sw<span class="_ _9"> </span>a2,<span class="_ _31"> </span>(a0)<span class="_ _3b"> </span>#<span class="_ _31"> </span>*a<span class="_ _31"> </span>=<span class="_ _31"> </span>tmp</span></div><div class="t m0 xd5 h8 y12d0 ff24 fs12 fc0 sc0 ls0 ws0">6<span class="_ _32"> </span><span class="ff5 fs4">ret</span></div><div class="t m0 x13 h7 y12d1 ff3 fs4 fc0 sc0 ls0 ws0">Notice<span class="_ _30"> </span>that<span class="_ _30"> </span>the<span class="_ _2f"> </span>assem<span class="_ _1"></span>bly<span class="_ _30"> </span>co<span class="_ _4"></span>de<span class="_ _30"> </span>uses<span class="_ _30"> </span>registers<span class="_ _30"> </span><span class="ff5">a2<span class="_ _2f"> </span></span>and<span class="_ _30"> </span><span class="ff5">a3<span class="_ _30"> </span></span>to<span class="_ _2f"> </span>perform<span class="_ _2f"> </span>the<span class="_ _30"> </span>computation.</div><div class="t m0 x17 h7 y12d2 ff3 fs4 fc0 sc0 ls0 ws0">In<span class="_ _b"> </span>this<span class="_ _2"> </span>case,<span class="_ _b"> </span>the<span class="_ _2"> </span>conten<span class="_ _8"></span>ts<span class="_ _b"> </span>of<span class="_ _b"> </span>these<span class="_ _2"> </span>tw<span class="_ _8"></span>o<span class="_ _b"> </span>registers<span class="_ _2"> </span>are<span class="_ _b"> </span>destro<span class="_ _8"></span>yed<span class="_ _2"> </span>by<span class="_ _2"> </span>the<span class="_ _b"> </span><span class="ff5">lw<span class="_ _b"> </span></span>instructions</div><div class="t m0 x17 h7 y12d3 ff3 fs4 fc0 sc0 ls0 ws0">(lines<span class="_ _2"> </span>2<span class="_ _2"> </span>and<span class="_ _2"> </span>3).</div><div class="t m0 x13 h7 y12d4 ff3 fs4 fc0 sc0 ls0 ws0">No<span class="_ _1"></span>w,<span class="_ _2"> </span>lets<span class="_ _b"> </span>assume<span class="_ _2"> </span>that<span class="_ _b"> </span>the<span class="_ _2"> </span><span class="ff5">mix<span class="_ _2"> </span></span>routine<span class="_ _b"> </span>loads<span class="_ _2"> </span>an<span class="_ _b"> </span>“important<span class="_ _2"> </span>information”<span class="_ _2"> </span>on<span class="_ _b"> </span>reg-</div><div class="t m0 x17 h7 y12d5 ff3 fs4 fc0 sc0 ls0 ws0">ister<span class="_ _3"> </span><span class="ff5">a2<span class="_ _a"> </span></span>and,<span class="_ _25"> </span>b<span class="_ _4"></span>efore<span class="_ _3"> </span>using<span class="_ _a"> </span>this<span class="_ _a"> </span>information,<span class="_ _25"> </span>it<span class="_ _3"> </span>inv<span class="_ _8"></span>okes<span class="_ _3"> </span>the<span class="_ _a"> </span><span class="ff5">exchange<span class="_ _a"> </span></span>routine.<span class="_ _19"> </span>The</div><div class="t m0 x17 h7 y12d6 ff3 fs4 fc0 sc0 ls0 ws0">follo<span class="_ _1"></span>wing<span class="_ _b"> </span>co<span class="_ _4"></span>de<span class="_ _b"> </span>illustrates<span class="_ _b"> </span>this<span class="_ _3"> </span>situation.<span class="_ _26"> </span>First,<span class="_ _b"> </span>the<span class="_ _3"> </span><span class="ff5">mix<span class="_ _b"> </span></span>routine<span class="_ _b"> </span>loads<span class="_ _3"> </span>the<span class="_ _b"> </span>imp<span class="_ _4"></span>ortan<span class="_ _8"></span>t</div><div class="t m0 x17 h7 y12d7 ff3 fs4 fc0 sc0 ls0 ws0">information<span class="_ _3"> </span>into<span class="_ _3"> </span>register<span class="_ _3"> </span><span class="ff5">a2<span class="_ _a"> </span></span>(line<span class="_ _3"> </span>2).<span class="_ _0"> </span>Then,<span class="_ _25"> </span>it<span class="_ _3"> </span>sets<span class="_ _a"> </span>the<span class="_ _3"> </span>parameters<span class="_ _a"> </span>and<span class="_ _3"> </span>inv<span class="_ _8"></span>oke<span class="_ _3"> </span>the</div><div class="t m0 x17 h7 y12d8 ff5 fs4 fc0 sc0 ls0 ws0">exchange<span class="_ _b"> </span><span class="ff3">routine<span class="_ _3"> </span>(lines<span class="_ _3"> </span>3-5).<span class="_ _26"> </span>Finally<span class="_ _7"></span>,<span class="_ _3"> </span>the<span class="_ _b"> </span><span class="ff5">mix<span class="_ _3"> </span></span>routine<span class="_ _b"> </span>returns<span class="_ _3"> </span>the<span class="_ _3"> </span>important<span class="_ _b"> </span>infor-</span></div><div class="t m0 x17 h7 y12d9 ff3 fs4 fc0 sc0 ls0 ws0">mation<span class="_ _b"> </span>by<span class="_ _b"> </span>cop<span class="_ _8"></span>ying<span class="_ _b"> </span>it<span class="_ _3"> </span>from<span class="_ _b"> </span>register<span class="_ _b"> </span><span class="ff5">a2<span class="_ _b"> </span></span>to<span class="_ _b"> </span>register<span class="_ _b"> </span><span class="ff5">a0<span class="_ _3"> </span></span>(line<span class="_ _b"> </span>6)<span class="_ _b"> </span>and<span class="_ _b"> </span>executing<span class="_ _b"> </span>the<span class="_ _b"> </span><span class="ff5">ret</span></div><div class="t m0 x17 h7 y12da ff3 fs4 fc0 sc0 ls0 ws0">instruction<span class="_ _2"> </span>(line<span class="_ _2"> </span>7).</div><div class="t m0 xd5 h8 y12db ff24 fs12 fc0 sc0 ls0 ws0">1<span class="_ _16"> </span><span class="ff5 fs4">mix:</span></div><div class="t m0 xd5 h8 y12dc ff24 fs12 fc0 sc0 ls0 ws0">2<span class="_ _32"> </span><span class="ff5 fs4">lw<span class="_ _82"> </span>a2,<span class="_ _9"> </span>(a0)<span class="_ _3b"> </span>#<span class="_ _31"> </span>load<span class="_ _31"> </span>important<span class="_ _31"> </span>information<span class="_ _31"> </span>into<span class="_ _9"> </span>a2</span></div><div class="t m0 xd5 h8 y12dd ff24 fs12 fc0 sc0 ls0 ws0">3<span class="_ _32"> </span><span class="ff5 fs4">la<span class="_ _82"> </span>a0,<span class="_ _9"> </span>x<span class="_ _56"> </span>#<span class="_ _31"> </span>Sets<span class="_ _9"> </span>parameter<span class="_ _31"> </span>0<span class="_ _31"> </span>with<span class="_ _31"> </span>address<span class="_ _31"> </span>of<span class="_ _9"> </span>var.<span class="_ _31"> </span>x</span></div><div class="t m0 xd5 h8 y12de ff24 fs12 fc0 sc0 ls0 ws0">4<span class="_ _32"> </span><span class="ff5 fs4">la<span class="_ _82"> </span>a1,<span class="_ _9"> </span>y<span class="_ _56"> </span>#<span class="_ _31"> </span>Sets<span class="_ _9"> </span>parameter<span class="_ _31"> </span>1<span class="_ _31"> </span>with<span class="_ _31"> </span>address<span class="_ _31"> </span>of<span class="_ _9"> </span>var.<span class="_ _31"> </span>y</span></div><div class="t m0 xd5 h8 y12df ff24 fs12 fc0 sc0 ls0 ws0">5<span class="_ _32"> </span><span class="ff5 fs4">jal<span class="_ _9"> </span>exchange<span class="_ _32"> </span>#<span class="_ _9"> </span>Invokes<span class="_ _31"> </span>exchange<span class="_ _9"> </span>to<span class="_ _31"> </span>swap<span class="_ _31"> </span>x<span class="_ _31"> </span>an<span class="_ _31"> </span>y<span class="_ _31"> </span>values</span></div><div class="t m0 xd5 h8 y12e0 ff24 fs12 fc0 sc0 ls0 ws0">6<span class="_ _32"> </span><span class="ff5 fs4">mv<span class="_ _82"> </span>a0,<span class="_ _9"> </span>a2<span class="_ _86"> </span>#<span class="_ _31"> </span>Move<span class="_ _31"> </span>important<span class="_ _31"> </span>information<span class="_ _31"> </span>into<span class="_ _9"> </span>a0<span class="_ _31"> </span>to<span class="_ _31"> </span>return</span></div><div class="t m0 xd5 h8 y12e1 ff24 fs12 fc0 sc0 ls0 ws0">7<span class="_ _32"> </span><span class="ff5 fs4">ret</span></div><div class="t m0 x13 h7 y12e2 ff3 fs4 fc0 sc0 ls0 ws0">Notice,<span class="_ _2"> </span>how<span class="_ _8"></span>ever,<span class="_ _5"> </span>that<span class="_ _b"> </span>the<span class="_ _5"> </span><span class="ff5">exchange<span class="_ _2"> </span></span>routine<span class="_ _b"> </span>destro<span class="_ _8"></span>ys<span class="_ _2"> </span>the<span class="_ _2"> </span>conten<span class="_ _8"></span>ts<span class="_ _b"> </span>of<span class="_ _5"> </span>registers<span class="_ _b"> </span><span class="ff5">a2</span>.</div><div class="t m0 x17 h7 y12e3 ff3 fs4 fc0 sc0 ls0 ws0">Consequen<span class="_ _1"></span>tly<span class="_ _7"></span>,<span class="_ _b"> </span>the<span class="_ _2"> </span>v<span class="_ _8"></span>alue<span class="_ _b"> </span>returned<span class="_ _2"> </span>by<span class="_ _2"> </span>the<span class="_ _b"> </span><span class="ff5">mix<span class="_ _2"> </span></span>routine<span class="_ _b"> </span>is<span class="_ _2"> </span>not<span class="_ _b"> </span>the<span class="_ _b"> </span>“important<span class="_ _2"> </span>informa-</div><div class="t m0 x17 h7 y12e4 ff3 fs4 fc0 sc0 ls0 ws0">tion”<span class="_ _2"> </span>that<span class="_ _2"> </span>w<span class="_ _1"></span>as<span class="_ _2"> </span>loaded<span class="_ _2"> </span>in<span class="_ _1"></span>to<span class="_ _2"> </span>register<span class="_ _2"> </span><span class="ff5">a2<span class="_ _2"> </span></span>at<span class="_ _2"> </span>line<span class="_ _2"> </span>2.</div><div class="t m0 x13 h7 y66e ff3 fs4 fc0 sc0 ls0 ws0">T<span class="_ _7"></span>o solve the problem, the <span class="ff5">mix<span class="_ _37"> </span></span>routine could sav<span class="_ _8"></span>e the<span class="_ _5"> </span>con<span class="_ _1"></span>tents of register <span class="ff5">a2<span class="_ _2f"> </span></span>on the</div><div class="t m0 x17 h7 yd1 ff3 fs4 fc0 sc0 ls0 ws0">program stac<span class="_ _8"></span>k b<span class="_ _4"></span>efore<span class="_ _2f"> </span>in<span class="_ _1"></span>v<span class="_ _1"></span>oking the <span class="ff5">exchange<span class="_ _2f"> </span></span>routine and<span class="_ _2f"> </span>restore it<span class="_ _2f"> </span>after the<span class="_ _2f"> </span><span class="ff5">exchange</span></div><div class="t m0 x17 h7 yd2 ff3 fs4 fc0 sc0 ls0 ws0">routine returns.<span class="_ _3"> </span>The<span class="_ _2f"> </span>follo<span class="_ _1"></span>wing code illustrates this<span class="_ _2f"> </span>situation.<span class="_ _3"> </span>Notice that<span class="_ _2f"> </span>the con<span class="_ _8"></span>tents</div><div class="t m0 x17 h7 yd3 ff3 fs4 fc0 sc0 ls0 ws0">of<span class="_ _3"> </span>register<span class="_ _b"> </span><span class="ff5">a2<span class="_ _3"> </span></span>are<span class="_ _3"> </span>sa<span class="_ _8"></span>ved<span class="_ _b"> </span>into<span class="_ _b"> </span>the<span class="_ _3"> </span>program<span class="_ _3"> </span>stac<span class="_ _1"></span>k<span class="_ _3"> </span>(lines<span class="_ _b"> </span>3<span class="_ _3"> </span>and<span class="_ _3"> </span>4)<span class="_ _b"> </span>b<span class="_ _4"></span>efore<span class="_ _3"> </span>in<span class="_ _8"></span>voking<span class="_ _b"> </span>the</div><div class="t m0 x17 h7 y48 ff5 fs4 fc0 sc0 ls0 ws0">exchange<span class="_ _2"> </span><span class="ff3">routine<span class="_ _2"> </span>and<span class="_ _2"> </span>restored<span class="_ _2"> </span>(lines<span class="_ _2"> </span>8<span class="_ _2"> </span>and<span class="_ _2"> </span>9)<span class="_ _2"> </span>after<span class="_ _2"> </span>the<span class="_ _2"> </span></span>exchange<span class="_ _2"> </span><span class="ff3">routine<span class="_ _2"> </span>returns.</span></div><div class="t m0 x42 h7 yc ff5 fs4 fc0 sc0 ls0 ws0">http://riscv-<span class="_ _4"></span>programming.org<span class="_ _2"> </span><span class="ff3">(V<span class="_ _7"></span>ersion:<span class="_ _3"> </span>March<span class="_ _2"> </span>29,<span class="_ _2"> </span>2021)<span class="_ _85"> </span>98</span></div><a class="l" href="#pf6c" data-dest-detail='[108,"XYZ",90.709,771.024,null]'><div class="d m1" style="border-style:none;position:absolute;left:464.958000px;bottom:521.331000px;width:14.723000px;height:11.125000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="http://riscv-programming.org"><div class="d m1" style="border-style:none;position:absolute;left:187.121000px;bottom:36.395000px;width:148.940000px;height:13.948000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
