<div id="pf70" class="pf w0 h0" data-page-no="70"><div class="pc pc70 w0 h0"><img class="bi x13 y12cd w2 haa" alt="" src="bg70.png"/><div class="t m0 x13 h7 y15a ff3 fs4 fc0 sc0 ls0 ws0">CHAPTER<span class="_ _2"> </span>8.<span class="_ _22"> </span>IMPLEMENTING<span class="_ _2"> </span>ROUTINES</div><div class="t m0 x13 h7 y38 ff3 fs4 fc0 sc0 ls0 ws0">from<span class="_ _2"> </span>the<span class="_ _2"> </span><span class="ff5">get<span class="_ _d"> </span>current<span class="_ _a"> </span>day<span class="_ _2"> </span></span>routine,<span class="_ _2"> </span>the<span class="_ _2"> </span>stack<span class="_ _5"> </span>p<span class="_ _4"></span>oin<span class="_ _8"></span>ter<span class="_ _d"> </span>is<span class="_ _2"> </span>increased<span class="_ _2"> </span>to<span class="_ _2"> </span>deallo<span class="_ _4"></span>cate<span class="_ _5"> </span>the<span class="_ _2"> </span><span class="ff5">d</span></div><div class="t m0 x13 h7 yed ff3 fs4 fc0 sc0 ls0 ws0">v<span class="_ _8"></span>ariable<span class="_ _2"> </span>(line<span class="_ _2"> </span>6)<span class="_ _2"> </span>from<span class="_ _2"> </span>the<span class="_ _2"> </span>program<span class="_ _2"> </span>stac<span class="_ _1"></span>k.</div><div class="t m0 xd5 h8 y12ce ff24 fs12 fc0 sc0 ls0 ws0">1<span class="_ _1f"> </span><span class="ff5 fs4">get_current_day:</span></div><div class="t m0 xd5 h8 y12cf ff24 fs12 fc0 sc0 ls0 ws0">2<span class="_ _36"> </span><span class="ff5 fs4">addi<span class="_ _11"> </span>sp,<span class="_ _e"> </span>sp,<span class="_ _e"> </span>-12<span class="_ _3f"> </span>#<span class="_ _e"> </span>Allocate<span class="_ _11"> </span>d</span></div><div class="t m0 xd5 h8 y12d0 ff24 fs12 fc0 sc0 ls0 ws0">3<span class="_ _36"> </span><span class="ff5 fs4">mv<span class="_ _3f"> </span>a0,<span class="_ _11"> </span>sp<span class="_ _87"> </span>#<span class="_ _e"> </span>a0<span class="_ _e"> </span>=<span class="_ _e"> </span>address<span class="_ _11"> </span>of<span class="_ _e"> </span>d</span></div><div class="t m0 xd5 h8 y12d1 ff24 fs12 fc0 sc0 ls0 ws0">4<span class="_ _36"> </span><span class="ff5 fs4">jal<span class="_ _85"> </span>init_date<span class="_ _88"> </span>#<span class="_ _11"> </span>Invoke<span class="_ _e"> </span>the<span class="_ _e"> </span>init_date<span class="_ _e"> </span>routine</span></div><div class="t m0 xd5 h8 y12d2 ff24 fs12 fc0 sc0 ls0 ws0">5<span class="_ _36"> </span><span class="ff5 fs4">lw<span class="_ _3f"> </span>a0,<span class="_ _11"> </span>8(sp)<span class="_ _88"> </span>#<span class="_ _e"> </span>Load<span class="_ _e"> </span>d.day<span class="_ _e"> </span>into<span class="_ _11"> </span>a0</span></div><div class="t m0 xd5 h8 y12d3 ff24 fs12 fc0 sc0 ls0 ws0">6<span class="_ _36"> </span><span class="ff5 fs4">addi<span class="_ _11"> </span>sp,<span class="_ _e"> </span>sp,<span class="_ _e"> </span>12<span class="_ _86"> </span>#<span class="_ _11"> </span>Deallocate<span class="_ _e"> </span>d</span></div><div class="t m0 xd5 h8 y12d4 ff24 fs12 fc0 sc0 ls0 ws0">7<span class="_ _36"> </span><span class="ff5 fs4">ret</span></div><div class="t m0 x13 hd y12d5 ff6 fs3 fc0 sc0 ls0 ws0">8.7<span class="_ _36"> </span>Register<span class="_ _e"> </span>usage<span class="_ _e"> </span>p<span class="_ _4"></span>olicies</div><div class="t m0 x13 h7 y12d6 ff3 fs4 fc0 sc0 ls0 ws0">The<span class="_ _f"> </span>assembly<span class="_ _c"> </span>co<span class="_ _4"></span>de<span class="_ _f"> </span>examples<span class="_ _f"> </span>in<span class="_ _f"> </span>the<span class="_ _11"> </span>previous<span class="_ _f"> </span>sections<span class="_ _f"> </span>hav<span class="_ _8"></span>e<span class="_ _11"> </span>used<span class="_ _f"> </span>registers<span class="_ _f"> </span>to<span class="_ _f"> </span>hold</div><div class="t m0 x13 h7 y12d7 ff3 fs4 fc0 sc0 ls0 ws0">v<span class="_ _8"></span>ariables<span class="_ _12"> </span>and<span class="_ _12"> </span>temp<span class="_ _4"></span>orary<span class="_ _12"> </span>v<span class="_ _8"></span>alues, to<span class="_ _12"> </span>return<span class="_ _12"> </span>v<span class="_ _8"></span>alues<span class="_ _12"> </span>from<span class="_ _12"> </span>routines, and<span class="_ _12"> </span>to<span class="_ _12"> </span>pass<span class="_ _13"> </span>parameters</div><div class="t m0 x13 h7 y12d8 ff3 fs4 fc0 sc0 ls0 ws0">to<span class="_ _d"> </span>routines.<span class="_ _1f"> </span>In<span class="_ _d"> </span>fact,<span class="_ _a"> </span>registers<span class="_ _d"> </span>are<span class="_ _a"> </span>frequen<span class="_ _1"></span>tly<span class="_ _d"> </span>used<span class="_ _d"> </span>resources.<span class="_ _1f"> </span>Before<span class="_ _a"> </span>using<span class="_ _d"> </span>a<span class="_ _d"> </span>register,</div><div class="t m0 x13 h7 y12d9 ff3 fs4 fc0 sc0 ls0 ws0">ho<span class="_ _1"></span>w<span class="_ _1"></span>ev<span class="_ _1"></span>er, it ma<span class="_ _1"></span>y be necessary to sa<span class="_ _1"></span>v<span class="_ _1"></span>e its con<span class="_ _8"></span>tents to memory<span class="_ _13"> </span>so that it can<span class="_ _13"> </span>be restored</div><div class="t m0 x13 h7 y12da ff3 fs4 fc0 sc0 ls0 ws0">later.</div><div class="t m0 x14 h7 y12db ff3 fs4 fc0 sc0 ls0 ws0">Let<span class="_ _d"> </span>us<span class="_ _a"> </span>use<span class="_ _a"> </span>as<span class="_ _a"> </span>an<span class="_ _a"> </span>example<span class="_ _d"> </span>the<span class="_ _a"> </span><span class="ff5">exchange<span class="_ _a"> </span></span>routine,<span class="_ _a"> </span>introduced<span class="_ _a"> </span>in<span class="_ _a"> </span>Section<span class="_ _a"> </span>8.6.<span class="_ _1b"> </span>The</div><div class="t m0 x13 h7 y12dc ff3 fs4 fc0 sc0 ls0 ws0">follo<span class="_ _1"></span>wing<span class="_ _2"> </span>co<span class="_ _4"></span>des<span class="_ _5"> </span>show<span class="_ _5"> </span>its<span class="_ _2"> </span>implementation<span class="_ _5"> </span>in<span class="_ _2"> </span>assembly<span class="_ _5"> </span>language.</div><div class="t m0 xd5 h8 y12dd ff24 fs12 fc0 sc0 ls0 ws0">1<span class="_ _1f"> </span><span class="ff5 fs4">exchange:</span></div><div class="t m0 xd5 h8 y12de ff24 fs12 fc0 sc0 ls0 ws0">2<span class="_ _36"> </span><span class="ff5 fs4">lw<span class="_ _11"> </span>a2,<span class="_ _e"> </span>(a1)<span class="_ _3f"> </span>#<span class="_ _e"> </span>tmp<span class="_ _e"> </span>=<span class="_ _11"> </span>*b</span></div><div class="t m0 xd5 h8 y12df ff24 fs12 fc0 sc0 ls0 ws0">3<span class="_ _36"> </span><span class="ff5 fs4">lw<span class="_ _11"> </span>a3,<span class="_ _e"> </span>(a0)<span class="_ _3f"> </span>#<span class="_ _e"> </span>a3<span class="_ _e"> </span>=<span class="_ _11"> </span>*a</span></div><div class="t m0 xd5 h8 y12e0 ff24 fs12 fc0 sc0 ls0 ws0">4<span class="_ _36"> </span><span class="ff5 fs4">sw<span class="_ _11"> </span>a3,<span class="_ _e"> </span>(a1)<span class="_ _3f"> </span>#<span class="_ _e"> </span>*b<span class="_ _e"> </span>=<span class="_ _11"> </span>a3</span></div><div class="t m0 xd5 h8 y12e1 ff24 fs12 fc0 sc0 ls0 ws0">5<span class="_ _36"> </span><span class="ff5 fs4">sw<span class="_ _11"> </span>a2,<span class="_ _e"> </span>(a0)<span class="_ _3f"> </span>#<span class="_ _e"> </span>*a<span class="_ _e"> </span>=<span class="_ _11"> </span>tmp</span></div><div class="t m0 xd5 h8 y12e2 ff24 fs12 fc0 sc0 ls0 ws0">6<span class="_ _36"> </span><span class="ff5 fs4">ret</span></div><div class="t m0 x14 h7 y12e3 ff3 fs4 fc0 sc0 ls0 ws0">Notice<span class="_ _12"> </span>that<span class="_ _12"> </span>the<span class="_ _12"> </span>assembly<span class="_ _12"> </span>co<span class="_ _4"></span>de<span class="_ _12"> </span>uses<span class="_ _12"> </span>registers<span class="_ _12"> </span><span class="ff5">a2<span class="_ _12"> </span></span>and<span class="_ _12"> </span><span class="ff5">a3<span class="_ _12"> </span></span>to<span class="_ _12"> </span>p<span class="_ _4"></span>erform<span class="_ _12"> </span>the<span class="_ _12"> </span>computation.</div><div class="t m0 x13 h7 y12e4 ff3 fs4 fc0 sc0 ls0 ws0">In<span class="_ _d"> </span>this<span class="_ _d"> </span>case,<span class="_ _d"> </span>the<span class="_ _d"> </span>conten<span class="_ _8"></span>ts<span class="_ _d"> </span>of<span class="_ _d"> </span>these<span class="_ _d"> </span>tw<span class="_ _8"></span>o<span class="_ _d"> </span>registers<span class="_ _d"> </span>are<span class="_ _d"> </span>destro<span class="_ _1"></span>y<span class="_ _1"></span>ed<span class="_ _d"> </span>b<span class="_ _1"></span>y<span class="_ _d"> </span>the<span class="_ _d"> </span><span class="ff5">lw<span class="_ _d"> </span></span>instructions</div><div class="t m0 x13 h7 y12e5 ff3 fs4 fc0 sc0 ls0 ws0">(lines<span class="_ _2"> </span>2<span class="_ _2"> </span>and<span class="_ _2"> </span>3).</div><div class="t m0 x14 h7 y12e6 ff3 fs4 fc0 sc0 ls0 ws0">No<span class="_ _1"></span>w,<span class="_ _2"> </span>lets<span class="_ _d"> </span>assume<span class="_ _d"> </span>that<span class="_ _d"> </span>the<span class="_ _2"> </span><span class="ff5">mix<span class="_ _d"> </span></span>routine<span class="_ _d"> </span>loads<span class="_ _2"> </span>an<span class="_ _d"> </span>“imp<span class="_ _4"></span>ortan<span class="_ _8"></span>t<span class="_ _d"> </span>information”<span class="_ _d"> </span>on<span class="_ _2"> </span>reg-</div><div class="t m0 x13 h7 y12e7 ff3 fs4 fc0 sc0 ls0 ws0">ister<span class="_ _3"> </span><span class="ff5">a2<span class="_ _c"> </span></span>and,<span class="_ _f"> </span>b<span class="_ _4"></span>efore<span class="_ _3"> </span>using<span class="_ _c"> </span>this<span class="_ _c"> </span>information,<span class="_ _c"> </span>it<span class="_ _c"> </span>inv<span class="_ _8"></span>okes<span class="_ _3"> </span>the<span class="_ _c"> </span><span class="ff5">exchange<span class="_ _3"> </span></span>routine.<span class="_ _22"> </span>The</div><div class="t m0 x13 h7 y12e8 ff3 fs4 fc0 sc0 ls0 ws0">follo<span class="_ _1"></span>wing<span class="_ _a"> </span>co<span class="_ _4"></span>de<span class="_ _d"> </span>illustrates<span class="_ _3"> </span>this<span class="_ _a"> </span>situation.<span class="_ _2d"> </span>First,<span class="_ _3"> </span>the<span class="_ _a"> </span><span class="ff5">mix<span class="_ _a"> </span></span>routine<span class="_ _a"> </span>loads<span class="_ _3"> </span>the<span class="_ _a"> </span>imp<span class="_ _4"></span>ortan<span class="_ _8"></span>t</div><div class="t m0 x13 h7 y12e9 ff3 fs4 fc0 sc0 ls0 ws0">information<span class="_ _3"> </span>into<span class="_ _3"> </span>register<span class="_ _3"> </span><span class="ff5">a2<span class="_ _c"> </span></span>(line<span class="_ _3"> </span>2).<span class="_ _0"> </span>Then,<span class="_ _f"> </span>it<span class="_ _3"> </span>sets<span class="_ _c"> </span>the<span class="_ _3"> </span>parameters<span class="_ _c"> </span>and<span class="_ _3"> </span>inv<span class="_ _8"></span>oke<span class="_ _3"> </span>the</div><div class="t m0 x13 h7 y12ea ff5 fs4 fc0 sc0 ls0 ws0">exchange<span class="_ _a"> </span><span class="ff3">routine<span class="_ _3"> </span>(lines<span class="_ _a"> </span>3-5).<span class="_ _10"> </span>Finally<span class="_ _7"></span>,<span class="_ _3"> </span>the<span class="_ _a"> </span><span class="ff5">mix<span class="_ _3"> </span></span>routine<span class="_ _a"> </span>returns<span class="_ _3"> </span>the<span class="_ _a"> </span>imp<span class="_ _4"></span>ortan<span class="_ _1"></span>t<span class="_ _a"> </span>infor-</span></div><div class="t m0 x13 h7 y12eb ff3 fs4 fc0 sc0 ls0 ws0">mation<span class="_ _a"> </span>b<span class="_ _1"></span>y<span class="_ _a"> </span>cop<span class="_ _1"></span>ying<span class="_ _a"> </span>it<span class="_ _a"> </span>from<span class="_ _a"> </span>register<span class="_ _a"> </span><span class="ff5">a2<span class="_ _a"> </span></span>to<span class="_ _a"> </span>register<span class="_ _d"> </span><span class="ff5">a0<span class="_ _a"> </span></span>(line<span class="_ _a"> </span>6)<span class="_ _a"> </span>and<span class="_ _a"> </span>executing<span class="_ _a"> </span>the<span class="_ _a"> </span><span class="ff5">ret</span></div><div class="t m0 x13 h7 y12ec ff3 fs4 fc0 sc0 ls0 ws0">instruction<span class="_ _2"> </span>(line<span class="_ _2"> </span>7).</div><div class="t m0 xd5 h8 y12ed ff24 fs12 fc0 sc0 ls0 ws0">1<span class="_ _1f"> </span><span class="ff5 fs4">mix:</span></div><div class="t m0 xd5 h8 y12ee ff24 fs12 fc0 sc0 ls0 ws0">2<span class="_ _36"> </span><span class="ff5 fs4">lw<span class="_ _85"> </span>a2,<span class="_ _11"> </span>(a0)<span class="_ _3f"> </span>#<span class="_ _e"> </span>load<span class="_ _e"> </span>important<span class="_ _e"> </span>information<span class="_ _11"> </span>into<span class="_ _e"> </span>a2</span></div><div class="t m0 xd5 h8 y12ef ff24 fs12 fc0 sc0 ls0 ws0">3<span class="_ _36"> </span><span class="ff5 fs4">la<span class="_ _85"> </span>a0,<span class="_ _11"> </span>x<span class="_ _5a"> </span>#<span class="_ _11"> </span>Sets<span class="_ _e"> </span>parameter<span class="_ _e"> </span>0<span class="_ _e"> </span>with<span class="_ _11"> </span>address<span class="_ _e"> </span>of<span class="_ _e"> </span>var.<span class="_ _e"> </span>x</span></div><div class="t m0 xd5 h8 y12f0 ff24 fs12 fc0 sc0 ls0 ws0">4<span class="_ _36"> </span><span class="ff5 fs4">la<span class="_ _85"> </span>a1,<span class="_ _11"> </span>y<span class="_ _5a"> </span>#<span class="_ _11"> </span>Sets<span class="_ _e"> </span>parameter<span class="_ _e"> </span>1<span class="_ _e"> </span>with<span class="_ _11"> </span>address<span class="_ _e"> </span>of<span class="_ _e"> </span>var.<span class="_ _e"> </span>y</span></div><div class="t m0 xd5 h8 y12f1 ff24 fs12 fc0 sc0 ls0 ws0">5<span class="_ _36"> </span><span class="ff5 fs4">jal<span class="_ _11"> </span>exchange<span class="_ _3f"> </span>#<span class="_ _e"> </span>Invokes<span class="_ _e"> </span>exchange<span class="_ _e"> </span>to<span class="_ _11"> </span>swap<span class="_ _e"> </span>x<span class="_ _e"> </span>an<span class="_ _e"> </span>y<span class="_ _11"> </span>values</span></div><div class="t m0 xd5 h8 y12f2 ff24 fs12 fc0 sc0 ls0 ws0">6<span class="_ _36"> </span><span class="ff5 fs4">mv<span class="_ _85"> </span>a0,<span class="_ _11"> </span>a2<span class="_ _88"> </span>#<span class="_ _e"> </span>Move<span class="_ _e"> </span>important<span class="_ _e"> </span>information<span class="_ _11"> </span>into<span class="_ _e"> </span>a0<span class="_ _e"> </span>to<span class="_ _e"> </span>return</span></div><div class="t m0 xd5 h8 y12f3 ff24 fs12 fc0 sc0 ls0 ws0">7<span class="_ _36"> </span><span class="ff5 fs4">ret</span></div><div class="t m0 x14 h7 y12f4 ff3 fs4 fc0 sc0 ls0 ws0">Notice,<span class="_ _2"> </span>how<span class="_ _8"></span>ever,<span class="_ _5"> </span>that<span class="_ _d"> </span>the<span class="_ _2"> </span><span class="ff5">exchange<span class="_ _2"> </span></span>routine<span class="_ _2"> </span>destroys<span class="_ _2"> </span>the<span class="_ _2"> </span>conten<span class="_ _8"></span>ts<span class="_ _2"> </span>of<span class="_ _2"> </span>registers<span class="_ _d"> </span><span class="ff5">a2</span>.</div><div class="t m0 x13 h7 y12f5 ff3 fs4 fc0 sc0 ls0 ws0">Consequen<span class="_ _1"></span>tly<span class="_ _7"></span>,<span class="_ _d"> </span>the<span class="_ _d"> </span>v<span class="_ _8"></span>alue<span class="_ _d"> </span>returned<span class="_ _d"> </span>b<span class="_ _1"></span>y<span class="_ _d"> </span>the<span class="_ _d"> </span><span class="ff5">mix<span class="_ _2"> </span></span>routine<span class="_ _d"> </span>is<span class="_ _d"> </span>not<span class="_ _d"> </span>the<span class="_ _d"> </span>“imp<span class="_ _4"></span>ortan<span class="_ _1"></span>t<span class="_ _2"> </span>informa-</div><div class="t m0 x13 h7 y12f6 ff3 fs4 fc0 sc0 ls0 ws0">tion”<span class="_ _2"> </span>that<span class="_ _2"> </span>w<span class="_ _1"></span>as<span class="_ _2"> </span>loaded<span class="_ _2"> </span>in<span class="_ _1"></span>to<span class="_ _2"> </span>register<span class="_ _2"> </span><span class="ff5">a2<span class="_ _2"> </span></span>at<span class="_ _2"> </span>line<span class="_ _2"> </span>2.</div><div class="t m0 x14 h7 y683 ff3 fs4 fc0 sc0 ls0 ws0">T<span class="_ _7"></span>o solve the problem, the <span class="ff5">mix<span class="_ _38"> </span></span>routine could sav<span class="_ _8"></span>e the<span class="_ _5"> </span>conten<span class="_ _8"></span>ts of register <span class="ff5">a2<span class="_ _38"> </span></span>on<span class="_ _5"> </span>the</div><div class="t m0 x13 h7 yea ff3 fs4 fc0 sc0 ls0 ws0">program stac<span class="_ _8"></span>k b<span class="_ _4"></span>efore<span class="_ _13"> </span>in<span class="_ _1"></span>v<span class="_ _1"></span>oking the <span class="ff5">exchange<span class="_ _12"> </span></span>routine and restore it after<span class="_ _12"> </span>the <span class="ff5">exchange</span></div><div class="t m0 x13 h7 yeb ff3 fs4 fc0 sc0 ls0 ws0">routine returns.<span class="_ _a"> </span>The following<span class="_ _12"> </span>co<span class="_ _4"></span>de illustrates<span class="_ _13"> </span>this situation.<span class="_ _a"> </span>Notice that the con<span class="_ _8"></span>tents</div><div class="t m0 x13 h7 yec ff3 fs4 fc0 sc0 ls0 ws0">of<span class="_ _a"> </span>register<span class="_ _3"> </span><span class="ff5">a2<span class="_ _3"> </span></span>are<span class="_ _a"> </span>sav<span class="_ _8"></span>ed<span class="_ _3"> </span>into<span class="_ _a"> </span>the<span class="_ _a"> </span>program<span class="_ _3"> </span>stack<span class="_ _a"> </span>(lines<span class="_ _a"> </span>3<span class="_ _3"> </span>and<span class="_ _3"> </span>4)<span class="_ _a"> </span>b<span class="_ _4"></span>efore<span class="_ _a"> </span>inv<span class="_ _8"></span>oking<span class="_ _3"> </span>the</div><div class="t m0 x13 h7 y61 ff5 fs4 fc0 sc0 ls0 ws0">exchange<span class="_ _2"> </span><span class="ff3">routine<span class="_ _2"> </span>and<span class="_ _2"> </span>restored<span class="_ _2"> </span>(lines<span class="_ _2"> </span>8<span class="_ _2"> </span>and<span class="_ _2"> </span>9)<span class="_ _2"> </span>after<span class="_ _2"> </span>the<span class="_ _2"> </span></span>exchange<span class="_ _2"> </span><span class="ff3">routine<span class="_ _2"> </span>returns.</span></div><div class="t m0 x43 h7 yc ff5 fs4 fc0 sc0 ls0 ws0">http://riscv-<span class="_ _4"></span>programming.org<span class="_ _2"> </span><span class="ff3">(V<span class="_ _7"></span>ersion:<span class="_ _c"> </span>August<span class="_ _5"> </span>26,<span class="_ _d"> </span>2021)<span class="_ _6f"> </span>98</span></div><a class="l" href="#pf6d" data-dest-detail='[109,"XYZ",90.709,771.024,null]'><div class="d m1" style="border-style:none;position:absolute;left:464.958000px;bottom:521.331000px;width:14.723000px;height:11.125000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="http://riscv-programming.org"><div class="d m1" style="border-style:none;position:absolute;left:185.308000px;bottom:36.395000px;width:148.940000px;height:13.948000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
